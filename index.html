<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>Age of the Earth - Tree</title>
	<link rel="stylesheet" type="text/css" href="css/skin-vista/ui.dynatree.css" />
	<link rel="stylesheet" type="text/css" href="css/styles.css" />

	<script type="text/javascript" src="js/jquery-1.6.1.min.js"></script>
	<script type="text/javascript" src="js/jquery.ui.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.dynatree.min.js"></script>
	<script src="js/protovis-r3.2.js" type="text/javascript" charset="utf-8"></script>
	<script src="ages.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
	$(function(){
		$.ajax({
			url: 'ages_dyna.html',
			success: function (resp) {
				$('#tree').append(resp).dynatree({
					persist:true,
					onActivate: function (node) {
						//alert("You activated " + node.data.title);
					},
					onClick: function (node, event) {
						$('input#search').val(node.data.title);
						$('.metadata').css('display', 'block').empty().append('<h3>'+node.data.title+'</h3><p>loading!</p>');
						update(node.data.title);
						$.ajax({
							url: 'get_wiki.php?era='+node.data.title,
							//url: "http://en.wikipedia.org/w/api.php?action=parse&page="+node.data.key+"&format=json",
							dataType: 'json',
							success: function(resp) {
								console.log(resp[0]);
								$('.metadata').find('p').remove().end().find('h3').after(resp[0].description);
								$('ul li:nth-child(even)').addClass('highlight');
							},
							error: function(err) {
								console.log(err);
							}
						});
					}
				});
			}
		});
    });

	</script>
</head>
<body>
	<div id="center"><div id="fig">
    <div id="title"></div>
<script type="text/javascript+protovis">

function title(d) {
  return d.parentNode ? (title(d.parentNode) + "." + d.nodeName) : d.nodeName;
}

var re = "",
    color = pv.Colors.category19().by(function(d) d.parentNode.nodeName)
    nodes = pv.dom(earth_ages).root("earth_ages").nodes();

var vis = new pv.Panel()
    .width(560)
    .height(800)
	.right(30)
	.bottom(30);

var treemap = vis.add(pv.Layout.Treemap)
    .nodes(nodes)
    .round(true);

treemap.leaf.add(pv.Panel)
    .fillStyle(function(d) color(d).alpha(title(d).match(re) ? 1 : .2))
    .strokeStyle("#fff")
    .lineWidth(1)
    .antialias(false);

treemap.label.add(pv.Label)
    .textStyle(function(d) pv.rgb(0, 0, 0, title(d).match(re) ? 1 : .2));

vis.render();

/** Counts the number of matching classes, updating the title element. */
function count() {
  var classes = 0, bytes = 0, total = 0;
  for (var i = 0; i < nodes.length; i++) {
    var n = nodes[i];
    if(n.firstChild) continue;
    total += n.nodeValue;
    if (title(n).match(re)) {
      classes++;
      bytes += n.nodeValue;
    }
  }
  var percent = bytes / total * 100;
  document.getElementById("title").innerHTML
      = classes + " classes; "
      + bytes.toFixed(2) + " million years ("
      + percent.toFixed(percent < 10) + "%).";
}

/** Updates the visualization and count when a new query is entered. */
function update(query) {
  if (query != re) {
    re = new RegExp(query, "i");
    count();
    vis.render();
  }
}

count();

    </script>
  </div>
  <div id="tree">
	
  </div>
	<div id="controls">
		<div id="footer">
	      <label for="search">search: </label>
	      <input type="text" id="search" onkeyup="update(this.value)">
	    </div>
		<div class="metadata"></div>
	</div>
</div>
	
	
</body>
</html>